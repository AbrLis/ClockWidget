# ClockWidgetApp

## Описание
ClockWidgetApp — виджет часов для Windows, реализованный на WPF с поддержкой цифровых и аналоговых часов, гибкой настройкой внешнего вида, звуковыми сигналами, будильниками и таймерами, а также полной поддержкой локализации (русский и английский языки). Все данные (настройки, таймеры, будильники, длинные таймеры) сохраняются между сессиями. Проект использует современные практики C# (.NET 9, nullable, implicit usings, Roslynator, .NET analyzers).

## Основные возможности
- Цифровые и аналоговые часы (отображаются независимо)
- **Будильники и таймеры**: добавление, редактирование, удаление, запуск, остановка, уведомления и звуковые сигналы
- Настройка прозрачности фона и текста
- Изменяемый размер шрифта и аналоговых часов
- Звуковые сигналы: кукушка каждый час, сигнал каждые полчаса (опционально)
- Настройка поверх всех окон
- Сохранение и загрузка всех настроек, резервное копирование и восстановление из .bak
- Локализация интерфейса (русский, английский; легко добавить новые языки)
- Мгновенная смена языка во всех окнах
- Трей-меню для быстрого доступа к функциям
- Современная архитектура MVVM, DI (Dependency Injection)
- **Длинные таймеры**: установка таймеров на произвольную дату и время (например, на несколько дней или недель вперёд), уведомления, сохранение, локализованные тултипы (сохраняются между перезапусками)
- Публикация в один exe-файл, не требующий установки .NET

## Будильники и таймеры
- Вкладка "Будильники и таймеры" в окне настроек
- Можно создавать несколько таймеров и будильников
- Для каждого доступны: запуск, остановка, удаление, редактирование
- По срабатыванию появляется всплывающее окно с уведомлением и проигрывается соответствующий звук
- Все таймеры и будильники сохраняются между запусками приложения
- Тултипы и уведомления полностью локализованы

## Длинные таймеры
Длинные таймеры позволяют создавать напоминания на произвольную дату и время (например, через несколько дней, недель или месяцев). Это удобно для редких событий, встреч, дедлайнов и т.д.

- Добавление длинного таймера через вкладку "Будильники и таймеры" в окне настроек
- Для каждого длинного таймера можно указать имя и точное время срабатывания
- По срабатыванию появляется отдельное уведомление и проигрывается специальный звук
- Все длинные таймеры сохраняются между запусками приложения
- Для каждого длинного таймера отображается тултип (в окне настроек и в трее):
  - В окне настроек: имя и время, на которое установлен таймер
  - В трее: имя, время срабатывания и оставшееся время (всё локализовано)
- Полная поддержка локализации (русский, английский)

## Сборка и запуск

### Требования
- .NET 9.0 SDK (для сборки проекта. exe-файл в релизе не требует установки .NET, все зависимости уже включены)
- Windows 10/11

### Сборка
```sh
dotnet build
```

### Запуск
```sh
dotnet run --project ClockWidgetApp/ClockWidgetApp.csproj
```

### Публикация в один файл
```sh
.\publish-release.ps1
```

## Структура проекта

- `ClockWidgetApp/` — основной проект приложения (WPF)
  - `ViewModels/` — ViewModel для окон, элементов и бизнес-логики приложения. Реализуют паттерн MVVM: обеспечивают связь между UI (Views) и данными (Models), содержат команды, свойства для биндинга, обработку событий, логику отображения и взаимодействия пользователя с приложением.
  - `Models/` — модели данных и настроек (структуры для хранения состояния, настроек, таймеров, будильников, длинных таймеров).
  - `Data/` — классы для работы с хранением и загрузкой данных: репозитории, интерфейсы, обработка ошибок, сериализация/десериализация настроек, таймеров, будильников и длинных таймеров. Обеспечивает абстракцию над файловой системой и форматами хранения.
  - `Helpers/` — вспомогательные классы, конвертеры, менеджер локализации, LoggingConfigurator, ServiceConfigurator (утилиты, конвертеры для XAML, обработка локализации, настройка DI и логирования).
  - `Views/` — XAML и code-behind окон и диалогов (визуальные компоненты, окна, пользовательский интерфейс).
  - `Services/` — DI-сервисы, бизнес-логика, взаимодействие с ОС, ApplicationLifecycleService, TrayIconManager (логика работы с файлами, временем, звуком, системным треем, жизненным циклом приложения, централизованное хранение данных).
  - `Resources/` — иконки, звуки, строки локализации (все статические ресурсы: изображения, аудиофайлы, .resx-файлы для локализации).
- `CleanTest/` — модульные тесты (xUnit, Moq) для ViewModel, сервисов, бизнес-логики, сериализации и валидации (автоматизированные тесты для проверки корректности работы основных компонентов).

## Локализация
- Все строки UI вынесены в `.resx`-файлы (`StringsEng.resx`, `StringsRus.resx`)
- Менеджер локализации (`Helpers/LocalizationManager.cs`) централизует доступ к строкам и управляет языком
- Смена языка происходит мгновенно во всех окнах через событие `LanguageChanged`
- Локализованы все тултипы, уведомления, трей-меню, окна и сообщения
- Для добавления нового языка:
  1. Создайте новый `.resx`-файл в `Resources/Localization/` (например, `StringsDe.resx`)
  2. Добавьте обработку нового языка в `LocalizationManager`
  3. Добавьте ключи и переводы

## Настройки
- Все настройки пользователя хранятся в JSON (`widget_settings.json` в AppData)
- Настройки буферизуются и сохраняются при выходе из приложения
- Поддерживается резервное копирование настроек и восстановление из .bak
- Язык, внешний вид, поведение часов, звуковые сигналы, будильники и таймеры — всё настраивается через окно настроек
- Будильники, таймеры и длинные таймеры сохраняются автоматически

## Архитектура
- **MVVM**: разделение логики, UI и данных
- **Dependency Injection**: все сервисы и ViewModel регистрируются через DI-контейнер
- **AppDataService**: централизованный сервис для всех данных приложения (настройки, таймеры, будильники, длинные таймеры)
- **Ресурсы**: все строки, иконки, звуки вынесены в ресурсы
- **Локализация**: централизовано через `LocalizationManager`
- **Логирование**: централизовано через `LoggingConfigurator` (Serilog)

## Как добавить новую строку для локализации
1. Добавьте ключ и перевод в оба `.resx`-файла
2. Добавьте свойство в `LocalizedStrings` (если нужно биндингом в XAML)
3. Используйте через биндинг или через `LocalizationManager.GetString("Key")`

## Включение и настройка логирования
- Для управления уровнем логирования используйте флаг командной строки `--log-level=LEVEL` при запуске приложения.
- Доступные уровни: `TRACE`, `DEBUG`, `INFO`, `WARNING`, `ERROR`, `FATAL`
- Примеры:

```sh
# Включить отладочные сообщения
ClockWidgetApp.exe --log-level=DEBUG

# Только ошибки
ClockWidgetApp.exe --log-level=ERROR

# Для dotnet run:
dotnet run --project ClockWidgetApp/ClockWidgetApp.csproj -- --log-level=INFO
```

- По умолчанию используется уровень WARNING.
- Все логи пишутся в файл:
  - `%APPDATA%/ClockWidget/logs/clock-widget-<дата>.log`

---

## Тестирование

### Как запустить тесты

- Вариант 1 (универсальный):
  ```sh
  dotnet test CleanTest/CleanTest.csproj --logger "console;verbosity=normal"
  ```
- Вариант 2 (Windows, PowerShell):
  ```sh
  ./run-tests.ps1
  ```

### Что покрыто тестами
- Бизнес-логика ViewModel (таймеры, будильники, длинные таймеры)
- Сервисы: сохранение/загрузка/буферизация/резервное копирование настроек, сериализация/десериализация таймеров, будильников, длинных таймеров
- Валидация времени, граничные и ошибочные случаи
- Проверка невозможности добавления дубликатов
- Обработка повреждённых/пустых файлов, восстановление из .bak
- Буферизация и обновление настроек
- Покрытие тестами с использованием xUnit и Moq

> **Важно:** Интеграция с WPF (UI, Application.Current, DI-контейнер) не покрывается юнит-тестами и требует отдельного интеграционного тестирования.

---

## Вклад
PR и предложения приветствуются! Пишите баги и пожелания в Issues.

## Лицензия
MIT License